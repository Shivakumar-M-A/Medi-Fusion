<div id="history-section" class="mt-4">
    </div>

<script>
    // ... (omitted boilerplate code) ...

    async function loadHistory(patientId) {
    const section = document.getElementById('history-section');
    section.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>'; // Loading spinner

    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/history/${patientId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const result = await response.json();

        if (!response.ok) {
             throw new Error(result.error || 'Failed to fetch history data.');
        }

        if (result.history && result.history.length > 0) {
            section.innerHTML = ''; // Clear spinner
            
            result.history.forEach(rec => {
                let contentHtml = '';
                
                // üõ†Ô∏è UPDATED: Always display content as pre-formatted text
                contentHtml = `<pre class="mt-2 p-2 bg-light border rounded" style="white-space: pre-wrap; word-wrap: break-word;">${rec.data}</pre>`;
                
                section.innerHTML += `
                    <div class="record my-3 p-3 bg-white border rounded">
                        <p class="mb-1"><strong>Doctor:</strong> ${rec.doctorName}</p>
                        <p class="mb-1"><strong>Diagnosis:</strong> ${rec.disease}</p>
                        <p class="mb-2"><strong>Date:</strong> ${new Date(Number(rec.timestamp) * 1000).toLocaleString()}</p>
                        <div>
                            <strong>Prescription:</strong>
                            ${contentHtml}
                        </div>
                        <p class="mt-2 mb-0 small text-muted">
                            <strong>Transaction ID:</strong> ${rec.cid}
                        </p>
                    </div>
                `;
            });
        } else {
            section.innerHTML = '<div class="alert alert-info">No prescription history found for this patient.</div>';
        }
    } catch (error) {
        console.error("Error loading history:", error);
        section.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${error.message}</div>`;
    }
}
</script>